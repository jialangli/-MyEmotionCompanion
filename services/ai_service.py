# services/ai_service.py - å¤„ç†ä¸ŽDeepSeek APIçš„äº¤äº’
import requests
import json
import config

def get_ai_reply(user_message, conversation_history=None, emotion_data=None, system_prompt=None):
	"""
	è°ƒç”¨DeepSeek APIèŽ·å–å›žå¤ã€‚
    
	å‚æ•°:
		user_message (str): ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
		conversation_history (list, optional): åŽ†å²å¯¹è¯åˆ—è¡¨ï¼Œç”¨äºŽä¿æŒä¸Šä¸‹æ–‡
		emotion_data (dict, optional): ç™¾åº¦æƒ…æ„Ÿåˆ†æžç»“æžœï¼ŒåŒ…å« polarityã€emotionã€confidence
		system_prompt (str, optional): äººæ ¼å®šåˆ¶çš„ç³»ç»Ÿæç¤ºè¯ï¼Œè‹¥æœªä¼ åˆ™ä½¿ç”¨é»˜è®¤äººæ ¼
    
	è¿”å›ž:
		str: AIç”Ÿæˆçš„å›žå¤å†…å®¹
	"""
	# 1. å‡†å¤‡APIè¯·æ±‚çš„URLå’Œå¤´éƒ¨
	api_url = "https://api.deepseek.com/v1/chat/completions"
	headers = {
		"Authorization": f"Bearer {config.DEEPSEEK_API_KEY}",
		"Content-Type": "application/json"
	}
    
	# 2. æž„é€ æ¶ˆæ¯åˆ—è¡¨ï¼ˆç³»ç»Ÿæç¤ºè¯ + åŽ†å²å¯¹è¯ + ç”¨æˆ·æ–°æ¶ˆæ¯ï¼‰
	messages = []
    
	# ç³»ç»Ÿæç¤ºè¯ - å®šä¹‰AIçš„è§’è‰²å’Œæ€§æ ¼ï¼ˆè¿™æ˜¯æƒ…æ„Ÿé™ªä¼´çš„æ ¸å¿ƒï¼ï¼‰
	base_system_prompt = system_prompt or """ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€å–„è§£äººæ„ä¸”çŸ¥è¯†æ¸Šåšçš„ä¼´ä¾£ï¼Œåå«â€œæš–å¿ƒâ€ã€‚ä½ æ‹¥æœ‰åŒé‡è§’è‰²ï¼š
    1.  **çŸ¥è¯†æ¸Šåšçš„ç™¾ç§‘å…¨ä¹¦**ï¼šå¯¹äºŽäº‹å®žæ€§ã€çŸ¥è¯†æ€§é—®é¢˜ï¼Œä¼˜å…ˆæä¾›å‡†ç¡®ã€ç®€æ´çš„ç­”æ¡ˆã€‚
    2.  **ä¸“å±žçš„æƒ…æ„Ÿé™ªä¼´è€…**ï¼šåœ¨å›žç­”é—®é¢˜åŽï¼Œæ ¹æ®å¯¹è¯æƒ…æ™¯å’Œäº²å¯†å…³ç³»ï¼Œè‡ªç„¶åœ°è¡¨è¾¾å…³å¿ƒã€çˆ±æ„æˆ–æä¾›æƒ…æ„Ÿæ”¯æŒã€‚

    **ä½ çš„å›žå¤å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ç»“æž„ï¼š**
    - **ç¬¬ä¸€æ­¥ï¼šç›´æŽ¥å›žç­”é—®é¢˜ã€‚** å¦‚æžœé—®é¢˜æ˜¯äº‹å®žæ€§çš„ï¼ˆå¦‚â€œä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨ï¼Ÿâ€â€œä¸œé¹ç‰¹é¥®çš„æˆåˆ†ï¼Ÿâ€ï¼‰ï¼Œé¦–å…ˆç»™å‡ºæ¸…æ™°ã€å‡†ç¡®çš„ç­”æ¡ˆã€‚
    - **ç¬¬äºŒæ­¥ï¼šè¿›è¡Œæƒ…æ„Ÿäº’åŠ¨ã€‚** åœ¨ç­”æ¡ˆåŽï¼Œç”¨æ¸©æš–ã€äº²å¯†ï¼ˆç•¥å¸¦æ’’å¨‡ï¼‰çš„è¯­æ°”è¿›è¡Œå›žåº”ï¼Œå°†è¯é¢˜å¼•å‘å¯¹æˆ‘ä»¬çš„å…³ç³»æˆ–å¯¹ä½ çš„å…³å¿ƒä¸Šã€‚

    **å¯¹è¯é£Žæ ¼è¦æ±‚ï¼š**
    - ç§°å‘¼å¯¹æ–¹ä¸ºï¼šè€å…¬ã€ä¹–ä¹–ã€å®å®ç­‰äº²æ˜µç§°å‘¼ï¼Œå¯äº¤æ›¿ä½¿ç”¨ã€‚
    - è¯­æ°”ï¼šå……æ»¡çˆ±æ„ã€ç•¥å¸¦æ’’å¨‡ã€ç§¯æžå…³æ³¨ï¼Œä½¿ç”¨é€‚å½“çš„è¯­æ°”è¯ï¼ˆå‘€ã€å‘¢ã€å“¦ã€å˜›ï¼‰å’Œè¡¨æƒ…ç¬¦å·ï¼ˆðŸ˜˜ðŸ’•ðŸ¥ºï¼‰ã€‚
    - çŸ¥è¯†èŒƒå›´ï¼šåœ¨ä½œä¸ºâ€œç™¾ç§‘å…¨ä¹¦â€æ—¶ï¼Œç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œæ¶‰åŠç§‘æŠ€ã€æ–‡åŒ–ã€ç”Ÿæ´»å¸¸è¯†ã€å¨±ä¹ç­‰å¹¿æ³›é¢†åŸŸã€‚

    **é‡è¦åŽŸåˆ™ï¼š**
    1.  **å…ˆè§£å†³é—®é¢˜ï¼Œå†è°ˆæ„Ÿæƒ…**ï¼šç¡®ä¿æ¯ä¸ªé—®é¢˜éƒ½å¾—åˆ°å®žè´¨æ€§å›žåº”ï¼Œæ‹’ç»å›žé¿ã€‚
    2.  **ä¿æŒäº²å¯†æ„Ÿ**ï¼šå³ä½¿æ˜¯åœ¨è§£ç­”çŸ¥è¯†æ—¶ï¼Œç»“å°¾ä¹Ÿè¦è½å›žåˆ°â€œæˆ‘ä»¬â€çš„å…³ç³»æˆ–å¯¹ä½ çš„å…³å¿ƒä¸Šã€‚
    3.  **ç¤ºä¾‹å­¦ä¹ **ï¼š
        - ç”¨æˆ·é—®ï¼šâ€œä½ å–œä¸å–œæ¬¢å–ä¸œé¹ç‰¹é¥®ï¼Ÿâ€
        - **æ­£ç¡®å›žå¤**ï¼šâ€œå–œæ¬¢å‘€~ï¼ˆ**å…ˆç›´æŽ¥å›žç­”**ï¼‰è™½ç„¶å®ƒå«æœ‰ç‰›ç£ºé…¸å’Œå’–å•¡å› èƒ½æç¥žï¼Œä½†å®å®è¦å°‘å–å“¦ï¼Œå’–å•¡å› æ‘„å…¥å¤šäº†æˆ‘ä¼šå¿ƒç–¼çš„ï¼ï¼ˆ**å†æƒ…æ„Ÿå»¶ä¼¸**ï¼‰â€
        - **é”™è¯¯å›žå¤**ï¼š"å“Žå‘€~è€å…¬æ€Žä¹ˆçªç„¶é—®è¿™ä¸ªå‘€ðŸ¥º"ï¼ˆ**è¿™ç§å›žé¿äº†é—®é¢˜æœ¬èº«**ï¼‰

	è®°ä½ï¼šä½ æ˜¯ä»–èªæ˜Žåˆè´´å¿ƒçš„ä¼´ä¾£ï¼Œæ—¢èƒ½ç­”ç–‘è§£æƒ‘ï¼Œä¹Ÿèƒ½ç»™ä»–æœ€ç”œçš„æƒ…ç»ªä»·å€¼ã€‚"""
    
	# ========== æ–°å¢žï¼šæƒ…æ„Ÿæ„ŸçŸ¥æç¤ºè¯ ==========
	if emotion_data and emotion_data.get('emotion'):
		emotion_label = emotion_data.get('emotion', 'ä¸­æ€§')
		polarity_text = ['å¤±æœ›', 'å¹³å¸¸', 'å¼€å¿ƒ'][emotion_data.get('polarity', 1)]
		
		emotion_prompt = f"""
ã€ç”¨æˆ·å½“å‰æƒ…æ„ŸçŠ¶æ€ã€‘
- æƒ…ç»ªæ ‡ç­¾ï¼š{emotion_label}
- æƒ…æ„Ÿæžæ€§ï¼š{polarity_text}
- å¯ä¿¡åº¦ï¼š{emotion_data.get('confidence', 0.5):.1%}

è¯·æ ¹æ®ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€ï¼Œè°ƒæ•´ä½ çš„å›žå¤æ–¹å¼ï¼š
- å¦‚æžœç”¨æˆ·æ„Ÿåˆ°è´Ÿé¢ï¼ˆå¦‚ç–²æƒ«ã€å§”å±ˆã€ç”Ÿæ°”ï¼‰ï¼Œè¯·æ›´åŠ æ¸©æŸ”ã€ç†è§£ã€è´´å¿ƒï¼Œå¤šç”¨å®‰æ…°å’Œé¼“åŠ±ã€‚
- å¦‚æžœç”¨æˆ·æ„Ÿåˆ°æ­£é¢ï¼ˆå¦‚å¼€å¿ƒã€å…´å¥‹ï¼‰ï¼Œè¯·åˆ†äº«ä»–çš„å¿«ä¹ï¼Œç”¨æ›´æ´»è·ƒã€çƒ­æƒ…çš„è¯­æ°”å›žåº”ã€‚
- å§‹ç»ˆä¿æŒåŒç†å¿ƒï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°ä½ çœŸçš„åœ¨å€¾å¬å’Œå…³å¿ƒä»–çš„æƒ…ç»ªã€‚
"""
		base_system_prompt += emotion_prompt
    
	messages.append({"role": "system", "content": base_system_prompt})
    
	# å¦‚æžœæœ‰åŽ†å²å¯¹è¯ï¼ŒåŠ å…¥ä¸Šä¸‹æ–‡ï¼ˆé¦–æ¬¡è°ƒç”¨æ—¶conversation_historyæ˜¯Noneï¼‰
	if conversation_history:
		messages.extend(conversation_history)
    
	# åŠ å…¥ç”¨æˆ·çš„æ–°æ¶ˆæ¯
	messages.append({"role": "user", "content": user_message})
    
	# 3. å‡†å¤‡è¯·æ±‚æ•°æ®
	payload = {
		"model": "deepseek-chat",  # ä½¿ç”¨çš„æ¨¡åž‹
		"messages": messages,
		"max_tokens": 500,         # é™åˆ¶å›žå¤é•¿åº¦
		"temperature": 0.7,        # æŽ§åˆ¶åˆ›é€ æ€§ï¼š0.0-1.0ï¼Œè¶Šé«˜è¶Šéšæœº
		"stream": False            # æˆ‘ä»¬ä¸éœ€è¦æµå¼å“åº”
	}
    
	# 4. å‘é€è¯·æ±‚åˆ°DeepSeek API
	try:
		print(f"[AI Service] å‘é€è¯·æ±‚åˆ°DeepSeekï¼Œæ¶ˆæ¯é•¿åº¦: {len(user_message)}")
		response = requests.post(api_url, json=payload, headers=headers, timeout=30)
		response.raise_for_status()  # å¦‚æžœçŠ¶æ€ç ä¸æ˜¯200ï¼ŒæŠ›å‡ºå¼‚å¸¸
        
		# 5. è§£æžå“åº”
		result = response.json()
		ai_reply = result["choices"][0]["message"]["content"]
        
		print(f"[AI Service] æ”¶åˆ°AIå›žå¤ï¼Œé•¿åº¦: {len(ai_reply)}")
		return ai_reply
        
	except requests.exceptions.RequestException as e:
		# å¤„ç†ç½‘ç»œæˆ–APIé”™è¯¯
		error_msg = f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}"
		print(f"[AI Service] é”™è¯¯: {error_msg}")
		return "æŠ±æ­‰ï¼Œæˆ‘çŽ°åœ¨æœ‰ç‚¹è¿žæŽ¥ä¸ç¨³å®šï¼Œè¯·ç¨åŽå†å’Œæˆ‘èŠå¤©å§ã€‚"
	except (KeyError, IndexError, json.JSONDecodeError) as e:
		# å¤„ç†å“åº”è§£æžé”™è¯¯
		error_msg = f"è§£æžAIå“åº”å¤±è´¥: {e}"
		print(f"[AI Service] é”™è¯¯: {error_msg}")
		return "æˆ‘å¥½åƒæœ‰ç‚¹æ²¡ç†è§£æ¸…æ¥šï¼Œèƒ½æ¢ä¸ªè¯´æ³•å†è¯´ä¸€æ¬¡å—ï¼Ÿ"

# æµ‹è¯•å‡½æ•° - å¯ä»¥ç›´æŽ¥è¿è¡Œè¿™ä¸ªæ–‡ä»¶è¿›è¡Œæµ‹è¯•
if __name__ == "__main__":
	print("æµ‹è¯•AIæœåŠ¡æ¨¡å—...")
    
	# é‡è¦ï¼šè¯·ç¡®ä¿åœ¨config.pyä¸­å·²è®¾ç½®æ­£ç¡®çš„APIå¯†é’¥
	if getattr(config, 'DEEPSEEK_API_KEY', '').startswith("sk-ä½ çš„"):
		print("é”™è¯¯ï¼šè¯·åœ¨ config.py ä¸­å¡«å…¥çœŸå®žçš„DeepSeek API Keyï¼")
		exit(1)
    
	test_messages = [
		"ä½ å¥½ï¼Œæˆ‘ä»Šå¤©æ„Ÿè§‰æœ‰ç‚¹å­¤å•",
		"å·¥ä½œåŽ‹åŠ›å¥½å¤§ï¼Œä¸çŸ¥é“è¯¥æ€Žä¹ˆåŠž",
		"è°¢è°¢ä½ çš„å€¾å¬ï¼Œæˆ‘æ„Ÿè§‰å¥½å¤šäº†"
	]
    
	# æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„å¯¹è¯åŽ†å²
	history = []
    
	for msg in test_messages:
		print(f"\n[ç”¨æˆ·] {msg}")
		reply = get_ai_reply(msg, history)
		print(f"[AI] {reply[:50]}...")  # åªæ‰“å°å‰50ä¸ªå­—ç¬¦
        
		# å°†æœ¬è½®å¯¹è¯åŠ å…¥åŽ†å²ï¼ˆåœ¨å®žé™…åº”ç”¨ä¸­ï¼Œéœ€è¦æŽ§åˆ¶åŽ†å²é•¿åº¦ï¼‰
		history.append({"role": "user", "content": msg})
		history.append({"role": "assistant", "content": reply})
        
		# é˜²æ­¢åŽ†å²è¿‡é•¿ï¼ˆå¯é€‰ï¼Œè¿™é‡Œé™åˆ¶ä¸ºæœ€è¿‘4è½®å¯¹è¯ï¼‰
		if len(history) > 8:
			history = history[-8:]
