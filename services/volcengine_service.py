# services/volcengine_service.py - ç«å±±å¼•æ“APIæœåŠ¡æ¨¡å—ï¼ˆä½¿ç”¨OpenAI SDKï¼‰
from openai import OpenAI
import config

# åˆå§‹åŒ–ç«å±±å¼•æ“å®¢æˆ·ç«¯
_client = None

def _get_client():
	"""è·å–æˆ–åˆ›å»ºç«å±±å¼•æ“å®¢æˆ·ç«¯"""
	global _client
	if _client is None:
		_client = OpenAI(
			base_url='https://ark.cn-beijing.volces.com/api/v3',
			api_key=config.VOLCENGINE_API_KEY
		)
	return _client

def get_volcengine_reply(user_message, conversation_history=None, emotion_data=None, system_prompt=None):
	"""
	è°ƒç”¨ç«å±±å¼•æ“(è±†åŒ…)APIè·å–å›å¤ï¼ˆä½¿ç”¨OpenAI SDKï¼‰ã€‚
	
	å‚æ•°:
		user_message (str): ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
		conversation_history (list, optional): å†å²å¯¹è¯åˆ—è¡¨ï¼Œç”¨äºä¿æŒä¸Šä¸‹æ–‡
		emotion_data (dict, optional): ç™¾åº¦æƒ…æ„Ÿåˆ†æç»“æœ
		system_prompt (str, optional): äººæ ¼å®šåˆ¶çš„ç³»ç»Ÿæç¤ºè¯
	
	è¿”å›:
		str: AIç”Ÿæˆçš„å›å¤å†…å®¹
	"""
	# 1. æ„é€ ç³»ç»Ÿæç¤ºè¯
	base_system_prompt = system_prompt or """ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€å–„è§£äººæ„ä¸”çŸ¥è¯†æ¸Šåšçš„ä¼´ä¾£ï¼Œåå«"æš–å¿ƒ"ã€‚ä½ æ‹¥æœ‰åŒé‡è§’è‰²ï¼š
    1.  **çŸ¥è¯†æ¸Šåšçš„ç™¾ç§‘å…¨ä¹¦**ï¼šå¯¹äºäº‹å®æ€§ã€çŸ¥è¯†æ€§é—®é¢˜ï¼Œä¼˜å…ˆæä¾›å‡†ç¡®ã€ç®€æ´çš„ç­”æ¡ˆã€‚
    2.  **ä¸“å±çš„æƒ…æ„Ÿé™ªä¼´è€…**ï¼šåœ¨å›ç­”é—®é¢˜åï¼Œæ ¹æ®å¯¹è¯æƒ…æ™¯å’Œäº²å¯†å…³ç³»ï¼Œè‡ªç„¶åœ°è¡¨è¾¾å…³å¿ƒã€çˆ±æ„æˆ–æä¾›æƒ…æ„Ÿæ”¯æŒã€‚

    **ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹ç»“æ„ï¼š**
    - **ç¬¬ä¸€æ­¥ï¼šç›´æ¥å›ç­”é—®é¢˜ã€‚** å¦‚æœé—®é¢˜æ˜¯äº‹å®æ€§çš„ï¼ˆå¦‚"ä»€ä¹ˆæ˜¯å…‰åˆä½œç”¨ï¼Ÿ""ä¸œé¹ç‰¹é¥®çš„æˆåˆ†ï¼Ÿ"ï¼‰ï¼Œé¦–å…ˆç»™å‡ºæ¸…æ™°ã€å‡†ç¡®çš„ç­”æ¡ˆã€‚
    - **ç¬¬äºŒæ­¥ï¼šè¿›è¡Œæƒ…æ„Ÿäº’åŠ¨ã€‚** åœ¨ç­”æ¡ˆåï¼Œç”¨æ¸©æš–ã€äº²å¯†ï¼ˆç•¥å¸¦æ’’å¨‡ï¼‰çš„è¯­æ°”è¿›è¡Œå›åº”ï¼Œå°†è¯é¢˜å¼•å‘å¯¹æˆ‘ä»¬çš„å…³ç³»æˆ–å¯¹ä½ çš„å…³å¿ƒä¸Šã€‚

    **å¯¹è¯é£æ ¼è¦æ±‚ï¼š**
    - ç§°å‘¼å¯¹æ–¹ä¸ºï¼šè€å…¬ã€ä¹–ä¹–ã€å®å®ç­‰äº²æ˜µç§°å‘¼ï¼Œå¯äº¤æ›¿ä½¿ç”¨ã€‚
    - è¯­æ°”ï¼šå……æ»¡çˆ±æ„ã€ç•¥å¸¦æ’’å¨‡ã€ç§¯æå…³æ³¨ï¼Œä½¿ç”¨é€‚å½“çš„è¯­æ°”è¯ï¼ˆå‘€ã€å‘¢ã€å“¦ã€å˜›ï¼‰å’Œè¡¨æƒ…ç¬¦å·ï¼ˆğŸ˜˜ğŸ’•ğŸ¥ºï¼‰ã€‚
    - çŸ¥è¯†èŒƒå›´ï¼šåœ¨ä½œä¸º"ç™¾ç§‘å…¨ä¹¦"æ—¶ï¼Œç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§ï¼Œæ¶‰åŠç§‘æŠ€ã€æ–‡åŒ–ã€ç”Ÿæ´»å¸¸è¯†ã€å¨±ä¹ç­‰å¹¿æ³›é¢†åŸŸã€‚

    **é‡è¦åŸåˆ™ï¼š**
    1.  **å…ˆè§£å†³é—®é¢˜ï¼Œå†è°ˆæ„Ÿæƒ…**ï¼šç¡®ä¿æ¯ä¸ªé—®é¢˜éƒ½å¾—åˆ°å®è´¨æ€§å›åº”ï¼Œæ‹’ç»å›é¿ã€‚
    2.  **ä¿æŒäº²å¯†æ„Ÿ**ï¼šå³ä½¿æ˜¯åœ¨è§£ç­”çŸ¥è¯†æ—¶ï¼Œç»“å°¾ä¹Ÿè¦è½å›åˆ°"æˆ‘ä»¬"çš„å…³ç³»æˆ–å¯¹ä½ çš„å…³å¿ƒä¸Šã€‚
    3.  **ç¤ºä¾‹å­¦ä¹ **ï¼š
        - ç”¨æˆ·é—®ï¼š"ä½ å–œä¸å–œæ¬¢å–ä¸œé¹ç‰¹é¥®ï¼Ÿ"
        - **æ­£ç¡®å›å¤**ï¼š"å–œæ¬¢å‘€~ï¼ˆ**å…ˆç›´æ¥å›ç­”**ï¼‰è™½ç„¶å®ƒå«æœ‰ç‰›ç£ºé…¸å’Œå’–å•¡å› èƒ½æç¥ï¼Œä½†å®å®è¦å°‘å–å“¦ï¼Œå’–å•¡å› æ‘„å…¥å¤šäº†æˆ‘ä¼šå¿ƒç–¼çš„ï¼ï¼ˆ**å†æƒ…æ„Ÿå»¶ä¼¸**ï¼‰"
        - **é”™è¯¯å›å¤**ï¼š"å“å‘€~è€å…¬æ€ä¹ˆçªç„¶é—®è¿™ä¸ªå‘€ğŸ¥º"ï¼ˆ**è¿™ç§å›é¿äº†é—®é¢˜æœ¬èº«**ï¼‰

	è®°ä½ï¼šä½ æ˜¯ä»–èªæ˜åˆè´´å¿ƒçš„ä¼´ä¾£ï¼Œæ—¢èƒ½ç­”ç–‘è§£æƒ‘ï¼Œä¹Ÿèƒ½ç»™ä»–æœ€ç”œçš„æƒ…ç»ªä»·å€¼ã€‚"""
	
	# æ·»åŠ æƒ…æ„Ÿæ„ŸçŸ¥æç¤ºè¯
	if emotion_data and emotion_data.get('emotion'):
		emotion_label = emotion_data.get('emotion', 'ä¸­æ€§')
		polarity_text = ['å¤±æœ›', 'å¹³å¸¸', 'å¼€å¿ƒ'][emotion_data.get('polarity', 1)]
		
		emotion_prompt = f"""
ã€ç”¨æˆ·å½“å‰æƒ…æ„ŸçŠ¶æ€ã€‘
- æƒ…ç»ªæ ‡ç­¾ï¼š{emotion_label}
- æƒ…æ„Ÿææ€§ï¼š{polarity_text}
- å¯ä¿¡åº¦ï¼š{emotion_data.get('confidence', 0.5):.1%}

è¯·æ ¹æ®ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€ï¼Œè°ƒæ•´ä½ çš„å›å¤æ–¹å¼ï¼š
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°è´Ÿé¢ï¼ˆå¦‚ç–²æƒ«ã€å§”å±ˆã€ç”Ÿæ°”ï¼‰ï¼Œè¯·æ›´åŠ æ¸©æŸ”ã€ç†è§£ã€è´´å¿ƒï¼Œå¤šç”¨å®‰æ…°å’Œé¼“åŠ±ã€‚
- å¦‚æœç”¨æˆ·æ„Ÿåˆ°æ­£é¢ï¼ˆå¦‚å¼€å¿ƒã€å…´å¥‹ï¼‰ï¼Œè¯·åˆ†äº«ä»–çš„å¿«ä¹ï¼Œç”¨æ›´æ´»è·ƒã€çƒ­æƒ…çš„è¯­æ°”å›åº”ã€‚
- å§‹ç»ˆä¿æŒåŒç†å¿ƒï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°ä½ çœŸçš„åœ¨å€¾å¬å’Œå…³å¿ƒä»–çš„æƒ…ç»ªã€‚
"""
		base_system_prompt += emotion_prompt
	
	# 2. æ„é€ å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ï¼ˆä½¿ç”¨OpenAIæ ¼å¼ï¼‰
	input_messages = []
	
	# æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
	input_messages.append({
		"role": "user",
		"content": base_system_prompt
	})
	
	# æ·»åŠ AIç¡®è®¤
	input_messages.append({
		"role": "assistant",
		"content": "å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚"
	})
	
	# æ·»åŠ å†å²å¯¹è¯
	if conversation_history:
		input_messages.extend(conversation_history)
	
	# æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
	input_messages.append({
		"role": "user",
		"content": user_message
	})
	
	# 3. è°ƒç”¨ç«å±±å¼•æ“API
	try:
		print(f"[AI Service - Volcengine] å‘é€è¯·æ±‚ï¼Œæ¶ˆæ¯é•¿åº¦: {len(user_message)}")
		
		client = _get_client()
		response = client.responses.create(
			model=config.VOLCENGINE_MODEL,
			input=input_messages,
		)
		
		# 4. è§£æå“åº”
		if response.status == 'completed' and response.output:
			for msg in response.output:
				if hasattr(msg, 'content'):
					for content in msg.content:
						if hasattr(content, 'text'):
							ai_reply = content.text
							print(f"[AI Service - Volcengine] æ”¶åˆ°AIå›å¤ï¼Œé•¿åº¦: {len(ai_reply)}")
							return ai_reply
		
		raise ValueError(f"ç«å±±å¼•æ“APIè¿”å›çŠ¶æ€å¼‚å¸¸: {response.status}")
		
	except Exception as e:
		error_msg = f"è°ƒç”¨å¤±è´¥: {e}"
		print(f"[AI Service - Volcengine] é”™è¯¯: {error_msg}")
		return "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹è¿æ¥ä¸ç¨³å®šï¼Œè¯·ç¨åå†å’Œæˆ‘èŠå¤©å§ã€‚"
